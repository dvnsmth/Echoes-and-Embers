<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Echoes and Embers â€“ RPG (Vertical Slice)</title>
  <link rel="stylesheet" href="./styles.css">

  <!-- ES Module import map for clean paths -->
  <script type="importmap">
  {
    "imports": {
      "data/":    "./scripts/data/",
      "systems/": "./scripts/systems/",
      "town/":    "./scripts/town/",
      "quests/":  "./scripts/quests/",
      "ui/":      "./scripts/ui/",
      "dev/":     "./scripts/dev/",
      "town":     "./scripts/town/index.js"
    }
  }
  </script>
</head>
<body>
<div id="app">
  <header class="row">
    <div class="avatar">ğŸ—¡ï¸âœ¨</div>
    <h1>Echoes and Embers</h1>
    <div class="spacer"></div>

    <!-- Quick access -->
    <button class="btn small" onclick="UI?.goto?.('inventory')">Inventory</button>
    <button class="btn small" onclick="UI?.goto?.('sheet')">Characters</button>
    <button class="btn small" onclick="openJournal()">Journal</button>

    <!-- Settings & system -->
    <button class="btn small" id="btnSettings">Settings</button>
    <button class="btn small" id="btnSave">Save</button>
    <button class="btn small" id="btnLoad">Load</button>
    <button class="btn small" id="btnReset">Reset</button>
  </header>

  <!-- Start Menu Overlay -->
  <div id="start-overlay" class="is-hidden" aria-hidden="true" role="dialog" aria-label="Start Menu">
    <div id="start-card">
      <h1>Echoes and Embers</h1>
      <p>Lightweight, text-first fantasy RPG. Create a party, talk to NPCs, and tackle the Hollowroot quest.</p>
      <div class="choice-list">
        <button class="btn primary" id="btnNewGame">ğŸŒŸ New Game</button>
        <button class="btn" id="btnContinue">â–¶ Continue</button>
      </div>
      <div class="divider" style="margin:10px 0"></div>
      <div class="row">
        <span class="pill">Tip: Use <b>Save/Load</b> in the header anytime.</span>
        <div class="spacer"></div>
        <button class="btn small" id="btnCloseStart">Close</button>
      </div>
    </div>
  </div>

  <!-- Pre-Battle Preview Overlay -->
  <div id="prebattle-overlay" class="overlay is-hidden" aria-hidden="true" role="dialog" aria-label="Battle Preview">
    <div class="overlay-card">
      <h2>Battle Preview</h2>
      <div id="pb-enemies" class="col" style="margin:8px 0"></div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <div class="pill">Reward: <b id="pb-gold">5â€“12</b> gold</div>
        <div class="pill">XP: <b id="pb-xp">30â€“60</b></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="pb-start">Start Battle</button>
        <button class="btn" id="pb-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Post-Battle Summary Overlay -->
  <div id="postbattle-overlay" class="overlay is-hidden" aria-hidden="true" role="dialog" aria-label="Battle Summary">
    <div class="overlay-card">
      <h2>Victory</h2>
      <div id="post-summary" class="col" style="max-height:50vh; overflow:auto; margin:8px 0"></div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <div class="pill">Gold: <b id="sum-gold">0</b></div>
        <div class="pill">XP: <b id="sum-xp">0</b></div>
        <div class="pill" id="sum-items">Items: â€”</div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="post-finish">Finish</button>
      </div>
    </div>
  </div>

  <main>
    <div id="location-hero" class="panel hero" aria-label="Location art"></div>

    <div id="screen-container" class="col">
      <!-- Main Menu -->
      <section id="screen-menu" class="screen active panel section">
        <h2>Welcome, traveler.</h2>
        <p class="tag">Create your party (up to 4), meet an NPC, and take on your first quest in the Vale.</p>
        <div class="choice-list">
          <button class="btn primary" onclick="UI.goto('create')">ğŸ§™ Create / Manage Party</button>
          <button class="btn" onclick="UI.goto('town')">ğŸ˜ï¸ Enter Thornbridge (Town)</button>
        </div>
      </section>

      <!-- Party Creator -->
      <section id="screen-create" class="screen panel section">
        <h2>Party</h2>
        <div class="grid cols-2">
          <div class="col">
            <h3>Create a Character</h3>
            <div class="grid cols-2">
              <label>Name<input id="cc-name" placeholder="Arin, Lira, ..."></label>
              <label>Race<select id="cc-race"></select></label>
              <label>Class<select id="cc-class"></select></label>
              <label>Background<input id="cc-bg" placeholder="(optional)"></label>
            </div>
            <div class="divider"></div>
            <h3>Allocate Stats (12 points)</h3>
            <div id="cc-stats" class="grid cols-3"></div>
            <div class="row">
              <span class="pill"><strong>Points</strong> <span id="cc-points">12</span></span>
              <div class="spacer"></div>
              <button class="btn good" id="cc-add">Add to Party</button>
              <button class="btn" id="cc-new">Create a New Character</button>
            </div>
            <p class="tag">
              Race bonuses apply on creation. Tap a stat to adjust. Stats use a compressed 10â€“60 scale and
              provide multiple benefits (e.g., DEX affects speed, crit, and defense).
            </p>
          </div>
          <div class="col">
            <h3>Current Party <span class="tag" id="party-count">0 / 4</span></h3>
            <div id="party-list" class="col"></div>
            <div class="row">
              <button class="btn" onclick="UI.goto('menu')">â¬… Back</button>
              <div class="spacer"></div>
              <button class="btn primary" onclick="UI.goto('town')">Enter Town</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Town -->
      <section id="screen-town" class="screen panel section">
        <h2>Thornbridge</h2>
        <p class="tag">A quiet frontier village at the edge of the Hollow Vale. Smoke curls from thatch roofs; wary eyes watch the woods.</p>
        <div class="choice-list">
          <button class="btn" onclick="townSquare()">ğŸ›ï¸ Town Square</button>
          <button class="btn" onclick="inn()">ğŸº The Fir & Finch Inn</button>
          <button class="btn" onclick="market()">ğŸ§º Market Stalls</button>
          <button class="btn" onclick="gate()">ğŸŒ² Vale Gate (Wilderness)</button>
          <button class="btn" onclick="blacksmith()">âš’ï¸ Blacksmith</button>
          <button class="btn" onclick="openJournal()">ğŸ“œ Quest Journal</button>
          <button class="btn" onclick="UI.goto('menu')">â¬… Main Menu</button>
        </div>
        <div id="town-output" class="log panel"></div>
      </section>

      <!-- Dialogue -->
      <section id="screen-dialogue" class="screen panel section">
        <div class="row" style="justify-content:space-between;align-items:center;gap:8px">
          <h2 id="dlg-name">NPC</h2>
          <button class="btn small" onclick="UI.backFromDialogue()">Done</button>
        </div>
        <div id="dlg-text" class="section" style="min-height:90px"></div>
        <div id="dlg-choices" class="choice-list"></div>
      </section>

      <!-- Combat -->
      <section id="screen-combat" class="screen panel section">
        <div class="row" style="align-items:center;gap:10px">
          <h2>âš”ï¸ Battle</h2>
          <div class="pill" id="turn-indicator" title="Current turn" style="margin-left:6px">â€”</div>
          <div class="pill" id="round-tracker" title="Turns elapsed" style="margin-left:6px">â€”</div>
          <div class="spacer"></div>
          <button class="btn small" onclick="Combat.tryFlee()">ğŸƒ Attempt Flee</button>
        </div>
        <div class="grid cols-2">
          <div class="col">
            <h3>Party</h3>
            <div id="combat-party" class="col"></div>
          </div>
          <div class="col">
            <h3>Enemies</h3>
            <div id="combat-enemies" class="col"></div>
          </div>
        </div>
        <div class="divider" style="margin-top:6px"></div>
        <div class="toolbar" id="combat-actions"></div>
        <div id="combat-log" class="log"></div>
      </section>

      <!-- Character Sheets -->
      <section id="screen-sheet" class="screen panel section">
        <h2>Character Sheet</h2>
        <div id="sheet-list" class="col"></div>
        <div class="row">
          <button class="btn" onclick="UI.goto('menu')">â¬… Back</button>
        </div>
      </section>

      <!-- Inventory -->
      <section id="screen-inventory" class="screen panel section">
        <h2>Inventory</h2>
        <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:6px">
          <div class="pill">ğŸ’° <b id="inv-gold">0</b> gold</div>
          <div class="pill">ğŸ’ <span id="inv-count">0</span> items</div>
        </div>
        <div id="inv-list" class="col"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="UI.goto('menu')">â¬… Back</button>
        </div>
      </section>

      <!-- Settings -->
      <section id="screen-settings" class="screen panel section">
        <h2>Settings</h2>
        <div class="grid cols-2">
          <div class="col">
            <h3>Accessibility</h3>
            <label>Text Size
              <select id="set-textsize">
                <option value="14">Small</option>
                <option value="16" selected>Default</option>
                <option value="18">Large</option>
                <option value="20">Extra Large</option>
              </select>
            </label>
            <label class="row"><input type="checkbox" id="set-reduced"> Reduce Motion</label>
          </div>
          <div class="col">
            <!-- Game options -->
            <div class="panel section" id="settings-quick">
              <h3>Game</h3>
              <div class="choice-list">
                <button class="btn" id="set-online">Online Connect</button>
                <button class="btn" id="set-load">Load</button>
                <button class="btn warn" id="set-quit">Quit to Start</button>
              </div>
              <p class="tag">These options are placeholders for now; weâ€™ll wire them up later.</p>
            </div>

            <div class="divider" style="margin:8px 0"></div>

            <!-- Music / SFX -->
            <div class="row" style="gap:8px;flex-wrap:wrap;align-items:center">
              <button class="btn small" id="music-toggle" type="button">Music: On</button>
              <label class="row" style="gap:6px;align-items:center">
                Music Volume
                <input id="bgm-volume" type="range" min="0" max="1" step="0.05" value="0.7" style="width:180px">
              </label>
            </div>
            <div class="row" style="gap:8px;flex-wrap:wrap;align-items:center; margin-top:6px">
              <label class="row" style="gap:6px;align-items:center">
                SFX Volume
                <input id="sfx-volume" type="range" min="0" max="1" step="0.01" value="0.8" style="width:180px">
              </label>
            </div>
            <p class="tag">SFX test buttons appear below.</p>

            <h3>Appearance</h3>
            <label>Theme
              <select id="set-theme">
                <option value="dark" selected>Dark</option>
                <option value="light">Light</option>
              </select>
            </label>
          </div>
        </div>
        <div class="divider" style="margin:8px 0"></div>
        <div class="row">
          <button class="btn primary" id="set-save">Save Settings</button>
          <button class="btn" id="set-reset">Reset to Defaults</button>
          <div class="spacer"></div>
          <button class="btn" onclick="UI.goto('menu')">â¬… Back</button>
        </div>
      </section>
    </div>

    <footer class="panel">
      Built as a single-file vertical slice. â„ï¸ Save/Load uses localStorage.
    </footer>
  </main>
</div>

<!-- DEV ONLY: deterministic console helpers for presets/spawn tables -->
<script type="module" src="./scripts/dev/encounter-demo.js"></script>

<!-- BEGIN: Inline Media Manager (bg images + music) -->
<script>
(function(){
  if (window.__LocationMediaInstalled) return;
  window.__LocationMediaInstalled = true;

  window.LOCATION_MEDIA = {
    "Start":         { image: "Assets/Backgrounds/start.png",       music: ["Assets/Music/start song.mp3"] },
    "CreateParty":   { image: "Assets/Backgrounds/start.png",       music: ["Assets/Music/start song.mp3"] },
    "Town Square":   { image: "Assets/Backgrounds/town_square.png", music: ["Assets/Music/town square.mp3"] },
    "Inn":           { image: "Assets/Backgrounds/inn.png",         music: ["Assets/Music/inn fire.mp3","Assets/Music/inn noise.mp3"] },
    "Market":        { image: "Assets/Backgrounds/market.png",      music: ["Assets/Music/market noise.mp3","Assets/Music/market song.mp3"] },
    "Wilderness":    { image: "Assets/Backgrounds/wilderness.png",  music: ["Assets/Music/wilderness.mp3","Assets/Music/woods.mp3"] },
    "Cave Entrance": { image: "Assets/Backgrounds/cave.png",        music: ["Assets/Music/cave music.mp3","Assets/Music/cave ambience.mp3"] },
    "Settings":      { image: "Assets/Backgrounds/settings.png",    music: ["Assets/Music/ourlordisnotready.mp3"] },
    "Inventory":     { image: "Assets/Backgrounds/inventorystats.png" },
    "Sheet":         { image: "Assets/Backgrounds/inventorystats.png" },
    "Menu":          { image: "Assets/Backgrounds/start.png",       music: ["Assets/Music/start song.mp3"] }
  };

  function ensureHero(){
    let el = document.getElementById('location-hero');
    if (!el){
      const tabbar = document.getElementById('tabbar');
      el = document.createElement('div');
      el.id = 'location-hero';
      el.className = 'panel hero';
      (tabbar || document.querySelector('main')).insertAdjacentElement('afterend', el);
      el.classList.add('collapsed'); 
    }
    return el;
  }

  function hardStopAllAudioElements(){
    document.querySelectorAll('audio').forEach(a => {
      try { a.pause(); } catch {}
      try { a.src = ''; a.removeAttribute('src'); a.load?.(); } catch {}
      try { a.remove(); } catch {}
    });
    (window.__bgmTracks||[]).forEach(a=>{ try{ a.pause(); a.src=''; a.remove(); }catch{} });
    window.__bgmTracks = [];
  }
  function currentVolume(){
    const v = parseFloat(localStorage.getItem('bgmVolume') || '0.7');
    return isNaN(v) ? 0.7 : Math.max(0, Math.min(1, v));
  }
  function currentMuted(){ return localStorage.getItem('bgmMuted') === 'true'; }
  function installAutoplayUnblocker(){
    if (window.__mediaAutoplayUnblockerInstalled) return;
    window.__mediaAutoplayUnblockerInstalled = true;
    const resume = () => (window.__bgmTracks||[]).forEach(a => a.play().catch(()=>{}));
    ['pointerdown','keydown'].forEach(ev =>
      document.addEventListener(ev, resume, { once:true, passive:true })
    );
  }
  function setBgm(sources){
    hardStopAllAudioElements();
    const list = Array.isArray(sources) ? sources : (sources ? [sources] : []);
    window.__bgmTracks = [];
    if (!list.length) return;
    installAutoplayUnblocker();
    list.forEach(src => {
      const safe = encodeURI(src);
      const a = new Audio(safe);
      a.loop = true;
      a.preload = 'auto';
      a.muted = currentMuted();
      a.volume = currentVolume();
      a.addEventListener('error', () => console.log('[media] audio error:', safe));
      document.body.appendChild(a);
      window.__bgmTracks.push(a);
      a.play().catch(() => console.log('[media] autoplay blocked; will resume on first interaction:', safe));
    });
  }

  window.MediaManager = {
    setLocation(key){
      const m = window.LOCATION_MEDIA[key] || {};
      const hero = ensureHero();

      if (m.image){
        hero.classList.remove('collapsed');
        hero.style.opacity = '0';
        const img = `url('${encodeURI(m.image)}')`;
        setTimeout(() => { hero.style.backgroundImage = img; hero.style.opacity = '1'; }, 60);
      } else {
        hero.style.backgroundImage = '';
        hero.classList.add('collapsed');
      }

      if (Object.prototype.hasOwnProperty.call(m, 'music')) setBgm(m.music);
      localStorage.setItem('lastLocation', key);
    },
    setInitialMusic(srcOrList){
      if (localStorage.getItem('bgmMuted') == null) localStorage.setItem('bgmMuted','false');
      if (localStorage.getItem('bgmVolume') == null) localStorage.setItem('bgmVolume','0.7');
      setBgm(srcOrList || ["Assets/Music/start song.mp3"]);
    },
    mute(flag){
      localStorage.setItem('bgmMuted', String(!!flag));
      (window.__bgmTracks||[]).forEach(a => a.muted = !!flag);
    },
    setVolume(v){
      const vol = Math.max(0, Math.min(1, Number(v)));
      localStorage.setItem('bgmVolume', String(vol));
      (window.__bgmTracks||[]).forEach(a => a.volume = vol);
    },
    stop(){ hardStopAllAudioElements(); }
  };
  window.setLocationMedia = window.MediaManager.setLocation;
})();
</script>
<!-- END: Inline Media Manager -->

<!-- App entry (module) -->
<script type="module" src="./scripts/main.js"></script>

<!-- Tab bar container (if used by UI.js) -->
<div class="tabs panel" id="tabbar"></div>
</body>
</html>
